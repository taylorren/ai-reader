<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ book.metadata.title }} - My Reader with AI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìö</text></svg>">
    
    <!-- MathJax for rendering mathematical equations -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    
    <style>
        /* Layout - Three Column */
        body { margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; font-family: "Georgia", serif; background: #fff; transition: background-color 0.3s, color 0.3s; }
        
        /* Dark mode */
        body.dark-mode { background: #1a1a1a; color: #e0e0e0; }
        body.dark-mode #sidebar { background: #2d2d2d; border-right-color: #404040; }
        body.dark-mode .nav-header { color: #e0e0e0; border-bottom-color: #404040; }
        body.dark-mode .nav-home { color: #64b5f6; }
        body.dark-mode .toc-link { color: #b0b0b0; }
        body.dark-mode .toc-link:hover { color: #e0e0e0; }
        body.dark-mode .toc-link.active { color: #ff6b9d; }
        body.dark-mode .content-container { color: #d0d0d0; }
        body.dark-mode .book-content h1,
        body.dark-mode .book-content h2,
        body.dark-mode .book-content h3 { color: #e0e0e0; }
        body.dark-mode .chapter-nav { border-top-color: #404040; }
        body.dark-mode .chapter-nav.sticky { background: #1a1a1a; border-bottom-color: #404040; }
        body.dark-mode .nav-btn { color: #64b5f6; border-color: #64b5f6; }
        body.dark-mode .nav-btn:hover { background: #64b5f6; color: #1a1a1a; }
        body.dark-mode .nav-btn.disabled { border-color: #555; color: #555; }
        body.dark-mode #ai-panel { background: #2d2d2d; border-left-color: #404040; }
        body.dark-mode .panel-header { background: #252525; border-bottom-color: #404040; }
        body.dark-mode .panel-title { color: #e0e0e0; }
        body.dark-mode .panel-close { color: #999; }
        body.dark-mode .panel-close:hover { color: #e0e0e0; }
        body.dark-mode .selected-text-box { background: #3d3520; border-left-color: #ffc107; }
        body.dark-mode .selected-text-label { color: #ffd54f; }
        body.dark-mode .selected-text-content { color: #d0d0d0; }
        body.dark-mode .analysis-box { background: #252525; border-color: #404040; }
        body.dark-mode .analysis-type { color: #999; }
        body.dark-mode .analysis-content { color: #d0d0d0; }
        body.dark-mode .markdown-content h1,
        body.dark-mode .markdown-content h2,
        body.dark-mode .markdown-content h3 { color: #e0e0e0; }
        body.dark-mode .markdown-content code { background: #3d3d3d; color: #e0e0e0; }
        body.dark-mode .markdown-content pre { background: #3d3d3d; }
        body.dark-mode .markdown-content blockquote { border-left-color: #555; color: #999; }
        body.dark-mode .markdown-content strong { color: #e0e0e0; }
        body.dark-mode .markdown-content a { color: #64b5f6; }
        body.dark-mode .markdown-content hr { border-top-color: #404040; }
        body.dark-mode .panel-actions { background: #252525; border-top-color: #404040; }
        body.dark-mode .btn-primary { background: #64b5f6; color: #1a1a1a; }
        body.dark-mode .btn-primary:hover { background: #42a5f5; }
        body.dark-mode .btn-secondary { background: #404040; color: #e0e0e0; }
        body.dark-mode .btn-secondary:hover { background: #505050; }
        body.dark-mode #context-menu { background: #2d2d2d; border-color: #404040; }
        body.dark-mode .context-menu-item { color: #e0e0e0; }
        body.dark-mode .context-menu-item:hover { background: #3d3d3d; }
        body.dark-mode .context-menu-separator { background: #404040; }
        body.dark-mode .settings-dropdown { background: #2d2d2d; border-color: #404040; }
        body.dark-mode .settings-label { color: #e0e0e0; }
        body.dark-mode .settings-option { background: #252525; border-color: #404040; color: #e0e0e0; }
        body.dark-mode .settings-option:hover { background: #3d3d3d; }
        body.dark-mode .settings-option.active { background: #64b5f6; color: #1a1a1a; }
        body.dark-mode #comment-textarea { background: #252525; border-color: #404040; color: #e0e0e0; }
        body.dark-mode .modal-content { background: #2d2d2d; }
        body.dark-mode .modal-header { background: #252525; border-bottom-color: #404040; }
        body.dark-mode .modal-title { color: #e0e0e0; }
        body.dark-mode .modal-close { color: #999; }
        body.dark-mode .modal-close:hover { color: #e0e0e0; }
        body.dark-mode .modal-body { color: #d0d0d0; }
        body.dark-mode .modal-body h1,
        body.dark-mode .modal-body h2,
        body.dark-mode .modal-body h3 { color: #e0e0e0; }

        /* Left Sidebar - TOC */
        #sidebar { width: 280px; background: #f8f9fa; border-right: 1px solid #e9ecef; overflow-y: auto; padding: 20px; flex-shrink: 0; }
        .nav-header { font-family: -apple-system, sans-serif; font-weight: bold; color: #495057; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6; }
        .nav-home { display: block; margin-bottom: 20px; color: #3498db; text-decoration: none; font-family: -apple-system, sans-serif; font-size: 0.9em; }

        /* TOC Tree */
        ul.toc-list { list-style: none; padding-left: 0; margin: 0; }
        ul.toc-list ul { padding-left: 20px; }
        li.toc-item { margin-bottom: 8px; }
        a.toc-link { text-decoration: none; color: #495057; font-size: 0.95em; display: block; padding: 4px 0; line-height: 1.4; }
        a.toc-link:hover { color: #000; text-decoration: underline; }
        a.toc-link.active { color: #d63384; font-weight: bold; }

        /* Main Content - Center */
        #main { flex-grow: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .content-container { max-width: 700px; margin: 0 auto; padding: 60px 40px; line-height: 1.8; font-size: 1.15em; color: #212529; }

        /* Content Styling */
        .book-content img { max-width: 100%; height: auto; display: block; margin: 20px auto; }
        .book-content h1, .book-content h2, .book-content h3 { font-family: -apple-system, sans-serif; margin-top: 1.5em; color: #333; }
        .book-content p { margin-bottom: 1.5em; text-align: justify; }

        /* Navigation Footer */
        .chapter-nav { display: flex; justify-content: space-between; margin-top: 60px; padding-top: 20px; border-top: 1px solid #eee; font-family: -apple-system, sans-serif; }
        .chapter-nav.sticky { position: sticky; top: 0; z-index: 100; background: white; margin-top: 0; padding: 15px 0; border-top: none; border-bottom: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .nav-btn { text-decoration: none; color: #3498db; font-weight: bold; padding: 10px 20px; border: 1px solid #3498db; border-radius: 4px; transition: all 0.2s; }
        .nav-btn:hover { background: #3498db; color: white; }
        .nav-btn.disabled { opacity: 0.5; pointer-events: none; border-color: #ccc; color: #ccc; }

        /* Right Panel - AI Analysis */
        #ai-panel { width: 400px; background: #fafbfc; border-left: 1px solid #e9ecef; overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; }
        #ai-panel.hidden { display: none !important; }
        
        .panel-header { padding: 20px; border-bottom: 1px solid #e9ecef; background: white; }
        .panel-title { font-family: -apple-system, sans-serif; font-size: 1.1em; font-weight: bold; color: #333; margin: 0; }
        .panel-close { float: right; cursor: pointer; color: #999; font-size: 1.3em; line-height: 1; }
        .panel-close:hover { color: #333; }
        
        .panel-content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        
        .selected-text-box { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin-bottom: 20px; border-radius: 4px; }
        .selected-text-label { font-family: -apple-system, sans-serif; font-size: 0.85em; color: #856404; font-weight: bold; margin-bottom: 8px; }
        .selected-text-content { font-style: italic; color: #333; line-height: 1.6; }
        
        .analysis-box { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 20px; }
        .analysis-type { font-family: -apple-system, sans-serif; font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .analysis-content { line-height: 1.8; color: #333; }
        
        /* Markdown styling */
        .markdown-content { font-size: 0.95em; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { margin-top: 1.2em; margin-bottom: 0.6em; color: #2c3e50; }
        .markdown-content h1 { font-size: 1.4em; border-bottom: 2px solid #e9ecef; padding-bottom: 0.3em; }
        .markdown-content h2 { font-size: 1.2em; }
        .markdown-content h3 { font-size: 1.05em; }
        .markdown-content p { margin-bottom: 1em; }
        .markdown-content ul, .markdown-content ol { margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-content li { margin-bottom: 0.4em; }
        .markdown-content code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: 'Consolas', monospace; font-size: 0.9em; }
        .markdown-content pre { background: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto; margin-bottom: 1em; }
        .markdown-content pre code { background: none; padding: 0; }
        .markdown-content blockquote { border-left: 3px solid #ddd; padding-left: 1em; margin-left: 0; color: #666; font-style: italic; }
        .markdown-content strong { font-weight: 600; color: #2c3e50; }
        .markdown-content em { font-style: italic; }
        .markdown-content a { color: #3498db; text-decoration: none; }
        .markdown-content a:hover { text-decoration: underline; }
        .markdown-content hr { border: none; border-top: 1px solid #e9ecef; margin: 1.5em 0; }
        .loading { text-align: center; padding: 40px; color: #999; }
        
        .panel-actions { padding: 15px 20px; border-top: 1px solid #e9ecef; background: white; display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border-radius: 6px; font-family: -apple-system, sans-serif; font-size: 0.9em; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-secondary { background: #e9ecef; color: #333; }
        .btn-secondary:hover { background: #dee2e6; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Context Menu */
        #context-menu { position: absolute; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px 0; display: none; z-index: 1000; min-width: 180px; }
        .context-menu-item { padding: 12px 20px; cursor: pointer; font-family: -apple-system, sans-serif; font-size: 0.9em; color: #333; transition: background 0.2s; display: flex; align-items: center; gap: 10px; }
        .context-menu-item:hover { background: #f0f0f0; }
        .context-menu-item:active { background: #e0e0e0; }
        .context-menu-separator { height: 1px; background: #e9ecef; margin: 4px 0; }

        /* Toggle Panel Button */
        .toggle-panel-btn { position: fixed; right: 20px; bottom: 20px; background: #3498db; color: white; border: none; border-radius: 50%; width: 56px; height: 56px; font-size: 1.5em; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 999; transition: all 0.2s; }
        .toggle-panel-btn:hover { background: #2980b9; transform: scale(1.05); }
        .toggle-panel-btn.hidden { display: none; }
        
        /* Settings Button & Dropdown */
        .settings-container { position: relative; display: inline-block; }
        .settings-btn { background: none; border: none; color: #666; font-size: 1.2em; cursor: pointer; padding: 8px; margin-left: 15px; transition: color 0.2s; }
        .settings-btn:hover { color: #333; }
        .settings-dropdown { position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; min-width: 280px; display: none; z-index: 1000; margin-top: 5px; }
        .settings-dropdown.show { display: block; }
        .settings-section { margin-bottom: 15px; }
        .settings-section:last-child { margin-bottom: 0; }
        .settings-label { font-family: -apple-system, sans-serif; font-size: 0.85em; font-weight: 600; color: #333; margin-bottom: 8px; display: block; }
        .settings-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .settings-option { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 0.85em; transition: all 0.2s; font-family: -apple-system, sans-serif; }
        .settings-option:hover { background: #f8f9fa; }
        .settings-option.active { background: #3498db; color: white; border-color: #3498db; }
        .settings-slider { width: 100%; }
        .settings-value { font-size: 0.85em; color: #666; margin-top: 5px; text-align: center; }

        /* Saved indicator */
        .saved-indicator { color: #28a745; font-size: 0.85em; margin-top: 10px; display: none; }
        .saved-indicator.show { display: block; }

        /* Saved Highlight markers - Color coded by type */
        .saved-highlight { 
            cursor: pointer !important;
            transition: all 0.2s;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* Fact Check - Yellow */
        .saved-highlight[data-analysis-type="fact_check"] {
            background-color: rgba(255, 235, 59, 0.35) !important;
            box-shadow: 0 -3px 0 0 #ffeb3b inset !important;
        }
        .saved-highlight[data-analysis-type="fact_check"]:hover {
            background-color: rgba(255, 235, 59, 0.5) !important;
            box-shadow: 0 -4px 0 0 #fdd835 inset !important;
        }
        
        /* Discussion - Blue */
        .saved-highlight[data-analysis-type="discussion"] {
            background-color: rgba(144, 202, 249, 0.35) !important;
            box-shadow: 0 -3px 0 0 #90caf9 inset !important;
        }
        .saved-highlight[data-analysis-type="discussion"]:hover {
            background-color: rgba(144, 202, 249, 0.5) !important;
            box-shadow: 0 -4px 0 0 #64b5f6 inset !important;
        }
        
        /* Comment - Green */
        .saved-highlight[data-analysis-type="comment"] {
            background-color: rgba(165, 214, 167, 0.35) !important;
            box-shadow: 0 -3px 0 0 #a5d6a7 inset !important;
        }
        .saved-highlight[data-analysis-type="comment"]:hover {
            background-color: rgba(165, 214, 167, 0.5) !important;
            box-shadow: 0 -4px 0 0 #81c784 inset !important;
        }
        
        /* Comment input area */
        #comment-input-area {
            display: none;
        }
        #comment-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            line-height: 1.6;
        }
        #comment-textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .comment-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #333;
            font-family: -apple-system, sans-serif;
        }
        
        /* Modal for internal links (footnotes, comments) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; max-width: 700px; max-height: 80vh; overflow-y: auto; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; margin: 20px; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e9ecef; background: #f8f9fa; border-radius: 8px 8px 0 0; }
        .modal-title { font-family: -apple-system, sans-serif; font-size: 1.1em; font-weight: bold; color: #333; margin: 0; }
        .modal-close { position: absolute; top: 15px; right: 20px; cursor: pointer; color: #999; font-size: 1.5em; line-height: 1; }
        .modal-close:hover { color: #333; }
        .modal-body { padding: 30px; line-height: 1.8; font-size: 1.05em; color: #212529; }
        .modal-body img { max-width: 100%; height: auto; }
        .modal-body h1, .modal-body h2, .modal-body h3 { font-family: -apple-system, sans-serif; margin-top: 1.5em; color: #333; }
        .modal-body p { margin-bottom: 1.5em; }
    </style>
</head>
<body>

    <!-- Left Sidebar - TOC -->
    <div id="sidebar">
        <a href="/" class="nav-home">‚Üê ËøîÂõûÂõæ‰π¶È¶Ü</a>
        <div class="nav-header">{{ book.metadata.title }}</div>

        {% macro render_toc(items) %}
            <ul class="toc-list">
            {% for item in items %}
                <li class="toc-item">
                    {% set is_active = current_chapter.href == item.file_href %}
                    <a href="#" onclick="findAndGo('{{ item.file_href }}')"
                       class="toc-link {% if is_active %}active{% endif %}">
                        {{ item.title }}
                    </a>
                    {% if item.children %}
                        {{ render_toc(item.children) }}
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% endmacro %}

        {{ render_toc(book.toc) }}
    </div>

    <!-- Main Content - Center -->
    <div id="main">
        <div class="content-container">
            <!-- Top Navigation (Sticky) -->
            <div class="chapter-nav sticky">
                {% if prev_idx is not none %}
                    <a href="/read/{{ book_id }}/{{ prev_idx }}" class="nav-btn">‚Üê ‰∏ä‰∏ÄÁ´†</a>
                {% else %}
                    <span class="nav-btn disabled">‚Üê ‰∏ä‰∏ÄÁ´†</span>
                {% endif %}

                <span style="color: #999; padding: 10px;">
                    Á¨¨ {{ chapter_index + 1 }} / {{ book.spine|length }} ËäÇ
                </span>

                {% if next_idx is not none %}
                    <a href="/read/{{ book_id }}/{{ next_idx }}" class="nav-btn">‰∏ã‰∏ÄÁ´† ‚Üí</a>
                {% else %}
                    <span class="nav-btn disabled">‰∏ã‰∏ÄÁ´† ‚Üí</span>
                {% endif %}
                
                <div class="settings-container">
                    <button class="settings-btn" onclick="toggleSettings(event)" title="Reading Settings">‚öôÔ∏è</button>
                    <div class="settings-dropdown" id="settings-dropdown">
                        <div class="settings-section">
                            <label class="settings-label">Theme</label>
                            <div class="settings-options">
                                <button class="settings-option active" onclick="setTheme('light')" data-theme="light">Light</button>
                                <button class="settings-option" onclick="setTheme('dark')" data-theme="dark">Dark</button>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <label class="settings-label">Font Family</label>
                            <div class="settings-options">
                                <button class="settings-option active" onclick="setFont('Georgia, serif')" data-font="georgia">Georgia</button>
                                <button class="settings-option" onclick="setFont('Times New Roman, serif')" data-font="times">Times</button>
                                <button class="settings-option" onclick="setFont('-apple-system, sans-serif')" data-font="sans">Sans</button>
                                <button class="settings-option" onclick="setFont('Arial, sans-serif')" data-font="arial">Arial</button>
                                <button class="settings-option" onclick="setFont('Verdana, sans-serif')" data-font="verdana">Verdana</button>
                                <button class="settings-option" onclick="setFont('Microsoft YaHei, sans-serif')" data-font="yahei">ÂæÆËΩØÈõÖÈªë</button>
                                <button class="settings-option" onclick="setFont('SimSun, serif')" data-font="simsun">ÂÆã‰Ωì</button>
                                <button class="settings-option" onclick="setFont('Consolas, monospace')" data-font="mono">Mono</button>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <label class="settings-label">Font Size</label>
                            <input type="range" class="settings-slider" min="14" max="24" value="18" step="1" oninput="setFontSize(this.value)">
                            <div class="settings-value" id="font-size-value">18px</div>
                        </div>
                        
                        <div class="settings-section">
                            <label class="settings-label">Line Height</label>
                            <input type="range" class="settings-slider" min="1.4" max="2.2" value="1.8" step="0.1" oninput="setLineHeight(this.value)">
                            <div class="settings-value" id="line-height-value">1.8</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="book-content" id="book-content">
                {{ current_chapter.content | safe }}
            </div>

            <!-- Bottom Navigation -->
            <div class="chapter-nav">
                {% if prev_idx is not none %}
                    <a href="/read/{{ book_id }}/{{ prev_idx }}" class="nav-btn">‚Üê ‰∏ä‰∏ÄÁ´†</a>
                {% else %}
                    <span class="nav-btn disabled">‚Üê ‰∏ä‰∏ÄÁ´†</span>
                {% endif %}

                <span style="color: #999; padding: 10px;">
                    Á¨¨ {{ chapter_index + 1 }} / {{ book.spine|length }} ËäÇ
                </span>

                {% if next_idx is not none %}
                    <a href="/read/{{ book_id }}/{{ next_idx }}" class="nav-btn">‰∏ã‰∏ÄÁ´† ‚Üí</a>
                {% else %}
                    <span class="nav-btn disabled">‰∏ã‰∏ÄÁ´† ‚Üí</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Panel - AI Analysis -->
    <div id="ai-panel" class="hidden">
        <div class="panel-header">
            <span class="panel-close" onclick="closePanel()">&times;</span>
            <h3 class="panel-title" id="panel-title">AI ÂàÜÊûê</h3>
        </div>
        
        <div class="panel-content">
            <div class="selected-text-box">
                <div class="selected-text-label">ÈÄâ‰∏≠ÁöÑÊñáÊú¨</div>
                <div class="selected-text-content" id="panel-selected-text"></div>
            </div>
            
            <div class="analysis-box" id="analysis-box">
                <div class="analysis-type" id="panel-analysis-type"></div>
                <div class="analysis-content markdown-content" id="panel-analysis-content">
                    <div class="loading">Á≠âÂæÖÂàÜÊûê...</div>
                </div>
            </div>
            
            <div id="comment-input-area">
                <label class="comment-label">‰Ω†ÁöÑÁ¨îËÆ∞:</label>
                <textarea id="comment-textarea" placeholder="Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÁöÑÊÉ≥Ê≥ï„ÄÅÁ¨îËÆ∞ÊàñËØÑËÆ∫..."></textarea>
            </div>
            
            <div class="saved-indicator" id="saved-indicator">
                ‚úì Â∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
            </div>
        </div>
        
        <div class="panel-actions" id="panel-actions">
            <button class="btn btn-primary" id="save-btn" onclick="saveAnalysis()" disabled>
                ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
            </button>
            <button class="btn btn-secondary" onclick="closePanel()">
                ÂÖ≥Èó≠
            </button>
        </div>
        
        <div class="panel-actions" id="comment-actions" style="display: none;">
            <button class="btn btn-primary" id="save-comment-btn" onclick="saveComment()">
                ‰øùÂ≠òÁ¨îËÆ∞
            </button>
            <button class="btn btn-primary" id="update-comment-btn" onclick="updateComment()" style="display: none;">
                Êõ¥Êñ∞Á¨îËÆ∞
            </button>
            <button class="btn btn-secondary" id="delete-comment-btn" onclick="deleteComment()" style="display: none; background: #f44336; color: white;">
                Âà†Èô§
            </button>
            <button class="btn btn-secondary" onclick="closePanel()">
                ÂèñÊ∂à
            </button>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
        <div class="context-menu-item" onclick="handleContextAction('fact_check')">
            Ëß£ÈáäËØ¥Êòé
        </div>
        <div class="context-menu-item" onclick="handleContextAction('discussion')">
            Ê∑±ÂÖ•ËÆ®ËÆ∫
        </div>
        <div class="context-menu-item" onclick="handleContextAction('comment')">
            Ê∑ªÂä†Á¨îËÆ∞
        </div>
    </div>

    <!-- Toggle Panel Button (when panel is hidden) -->
    <button class="toggle-panel-btn" id="toggle-panel-btn" onclick="togglePanel()" title="Open AI Panel">
        AI
    </button>
    
    <!-- Modal for internal links -->
    <div class="modal-overlay" id="link-modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal()">&times;</span>
                <h3 class="modal-title" id="modal-title">Reference</h3>
            </div>
            <div class="modal-body" id="modal-body">
                Loading...
            </div>
        </div>
    </div>

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    
    <script>
        // Configure marked for safe rendering
        marked.setOptions({
            breaks: true,
            gfm: true
        });
        
        // TOC Navigation
        const spineMap = {
            {% for ch in book.spine %}
            "{{ ch.href }}": {{ ch.order }},
            {% endfor %}
        };

        function findAndGo(filename) {
            const cleanFile = filename.split('#')[0];
            const idx = spineMap[cleanFile];
            if (idx !== undefined) {
                window.location.href = "/read/{{ book_id }}/" + idx;
            }
        }

        // AI Feature Variables
        const BOOK_ID = "{{ book_id }}";
        const CHAPTER_INDEX = {{ chapter_index }};
        let selectedText = "";
        let selectedContext = "";
        let currentHighlightId = null;
        let currentAnalysisId = null;
        let currentAnalysisType = "";
        let savedHighlights = []; // Store saved highlights for this chapter

        // Load saved highlights when page loads
        async function loadSavedHighlights() {
            try {
                const response = await fetch(`/api/highlights/${BOOK_ID}/${CHAPTER_INDEX}`);
                const data = await response.json();
                savedHighlights = data.highlights || [];
                
                console.log(`Loaded ${savedHighlights.length} highlights for chapter ${CHAPTER_INDEX}`);
                
                // Apply highlights to the content
                applyHighlights();
            } catch (error) {
                console.error('Error loading highlights:', error);
            }
        }

        // Apply highlights using Range-based approach (industry standard)
        // This is how tools like Hypothesis, Medium, and Google Docs do it
        function applyHighlights() {
            const bookContent = document.getElementById('book-content');
            
            // Clear existing highlights first and normalize text nodes
            const existingHighlights = bookContent.querySelectorAll('.saved-highlight');
            existingHighlights.forEach(span => {
                const parent = span.parentNode;
                while (span.firstChild) {
                    parent.insertBefore(span.firstChild, span);
                }
                parent.removeChild(span);
            });
            
            // Normalize text nodes to merge adjacent text nodes
            bookContent.normalize();
            
            if (savedHighlights.length === 0) return;
            
            // Find all text ranges first, then wrap them
            const ranges = [];
            
            savedHighlights.forEach((highlight) => {
                const text = highlight.selected_text;
                const analysisType = highlight.analyses && highlight.analyses.length > 0 
                    ? highlight.analyses[0].analysis_type 
                    : '';
                
                const range = findTextRange(bookContent, text);
                if (range) {
                    ranges.push({
                        range: range,
                        highlight: highlight,
                        analysisType: analysisType
                    });
                } else {
                    console.warn('Could not find text for highlight:', text.substring(0, 50) + '...');
                }
            });
            
            // Sort ranges by start position (latest first) to avoid position shifts
            ranges.sort((a, b) => {
                return b.range.compareBoundaryPoints(Range.START_TO_START, a.range);
            });
            
            // Apply highlights by marking affected elements
            ranges.forEach((item) => {
                try {
                    const range = item.range;
                    const commonAncestor = range.commonAncestorContainer;
                    
                    // Get all elements within the range
                    const walker = document.createTreeWalker(
                        commonAncestor.nodeType === Node.ELEMENT_NODE ? commonAncestor : commonAncestor.parentElement,
                        NodeFilter.SHOW_ELEMENT,
                        {
                            acceptNode: function(node) {
                                const nodeRange = document.createRange();
                                nodeRange.selectNodeContents(node);
                                
                                // Check if this node intersects with our highlight range
                                if (range.compareBoundaryPoints(Range.END_TO_START, nodeRange) < 0 &&
                                    range.compareBoundaryPoints(Range.START_TO_END, nodeRange) > 0) {
                                    return NodeFilter.FILTER_ACCEPT;
                                }
                                return NodeFilter.FILTER_SKIP;
                            }
                        }
                    );
                    
                    const elements = [];
                    let node;
                    while (node = walker.nextNode()) {
                        if (node.tagName === 'P' || node.tagName === 'DIV') {
                            elements.push(node);
                        }
                    }
                    
                    // If no block elements found, try to wrap inline
                    if (elements.length === 0) {
                        const span = document.createElement('span');
                        span.className = 'saved-highlight';
                        span.setAttribute('data-highlight-id', item.highlight.id);
                        span.setAttribute('data-analysis-type', item.analysisType);
                        span.title = 'üìã Click to view';
                        span.onclick = () => showSavedAnalysis(item.highlight);
                        
                        try {
                            range.surroundContents(span);
                        } catch (e) {
                            const contents = range.extractContents();
                            span.appendChild(contents);
                            range.insertNode(span);
                        }
                    } else {
                        // Mark each paragraph with highlight data
                        elements.forEach(el => {
                            el.classList.add('saved-highlight');
                            el.setAttribute('data-highlight-id', item.highlight.id);
                            el.setAttribute('data-analysis-type', item.analysisType);
                            el.style.cursor = 'pointer';
                            el.onclick = () => showSavedAnalysis(item.highlight);
                            
                            const tooltips = {
                                'fact_check': 'üìã Ëß£ÈáäËØ¥Êòé - ÁÇπÂáªÊü•Áúã',
                                'discussion': 'üí° Ê∑±ÂÖ•ËÆ®ËÆ∫ - ÁÇπÂáªÊü•Áúã',
                                'comment': 'üí¨ ‰∏™‰∫∫Á¨îËÆ∞ - ÁÇπÂáªÊü•Áúã/ÁºñËæë'
                            };
                            el.title = tooltips[item.analysisType] || 'Click to view';
                        });
                    }
                } catch (e) {
                    console.error(`Failed to apply highlight ${item.highlight.id}:`, e);
                }
            });
        }
        
        // Find text range in element with whitespace-tolerant matching
        function findTextRange(element, searchText) {
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            let fullText = '';
            const nodes = [];
            
            // Build a map of text nodes
            while (node = walker.nextNode()) {
                nodes.push({
                    node: node,
                    start: fullText.length,
                    end: fullText.length + node.textContent.length
                });
                fullText += node.textContent;
            }
            
            // Try exact match first
            let searchIndex = fullText.indexOf(searchText);
            let searchLength = searchText.length;
            
            // If no exact match, try with normalized whitespace
            if (searchIndex === -1) {
                // Create regex that allows flexible whitespace
                const pattern = searchText
                    .replace(/[.*+?^${}()|[\]\\]/g, '\\$&') // Escape special chars
                    .replace(/\s+/g, '\\s+'); // Allow any whitespace
                
                const regex = new RegExp(pattern);
                const match = fullText.match(regex);
                
                if (!match) {
                    return null;
                }
                
                searchIndex = match.index;
                searchLength = match[0].length;
            }
            
            const searchEnd = searchIndex + searchLength;
            
            // Find which text nodes contain the search text
            let startNode = null, startOffset = 0;
            let endNode = null, endOffset = 0;
            
            for (const item of nodes) {
                if (searchIndex >= item.start && searchIndex < item.end) {
                    startNode = item.node;
                    startOffset = searchIndex - item.start;
                }
                if (searchEnd > item.start && searchEnd <= item.end) {
                    endNode = item.node;
                    endOffset = searchEnd - item.start;
                }
                if (startNode && endNode) break;
            }
            
            if (!startNode || !endNode) {
                return null;
            }
            
            // Create range
            const range = document.createRange();
            range.setStart(startNode, startOffset);
            range.setEnd(endNode, endOffset);
            
            return range;
        }

        // Show saved analysis when clicking on a highlight
        function showSavedAnalysis(highlight) {
            openPanel();
            
            // Update panel content
            document.getElementById('panel-selected-text').textContent = highlight.selected_text;
            
            if (highlight.analyses && highlight.analyses.length > 0) {
                const analysis = highlight.analyses[0];
                
                // Check if it's a comment
                if (analysis.analysis_type === 'comment') {
                    // Show comment view with edit capability
                    document.getElementById('panel-title').textContent = 'üí¨ ÊàëÁöÑÁ¨îËÆ∞';
                    document.getElementById('analysis-box').style.display = 'none';
                    document.getElementById('comment-input-area').style.display = 'block';
                    document.getElementById('comment-textarea').value = analysis.response;
                    
                    // Show edit/delete buttons
                    document.getElementById('panel-actions').style.display = 'none';
                    document.getElementById('comment-actions').style.display = 'flex';
                    document.getElementById('save-comment-btn').style.display = 'none';
                    document.getElementById('update-comment-btn').style.display = 'inline-block';
                    document.getElementById('delete-comment-btn').style.display = 'inline-block';
                    
                    // Store IDs for update/delete
                    currentHighlightId = highlight.id;
                    currentAnalysisId = analysis.id;
                    currentAnalysisType = 'comment';
                    selectedText = highlight.selected_text;
                    
                } else {
                    // Show AI analysis (fact_check or discussion)
                    document.getElementById('panel-title').textContent = 'üìö Â∑≤‰øùÂ≠òÁöÑÂàÜÊûê';
                    document.getElementById('analysis-box').style.display = 'block';
                    document.getElementById('comment-input-area').style.display = 'none';
                    document.getElementById('panel-analysis-type').textContent = 
                        analysis.analysis_type === 'fact_check' ? 'Ëß£ÈáäËØ¥Êòé' : 'Ê∑±ÂÖ•ËÆ®ËÆ∫';
                    // Render markdown for AI responses
                    document.getElementById('panel-analysis-content').innerHTML = marked.parse(analysis.response);
                    
                    // Hide save button and show saved indicator
                    document.getElementById('panel-actions').style.display = 'flex';
                    document.getElementById('comment-actions').style.display = 'none';
                    document.getElementById('save-btn').style.display = 'none';
                    document.getElementById('saved-indicator').classList.add('show');
                }
            } else {
                document.getElementById('panel-title').textContent = 'üìö Â∑≤‰øùÂ≠òÁöÑÂàÜÊûê';
                document.getElementById('analysis-box').style.display = 'block';
                document.getElementById('comment-input-area').style.display = 'none';
                document.getElementById('panel-analysis-content').textContent = 'ÊöÇÊó†AIÂàÜÊûê';
                document.getElementById('panel-actions').style.display = 'flex';
                document.getElementById('comment-actions').style.display = 'none';
                document.getElementById('save-btn').style.display = 'none';
            }
        }

        // Load highlights and restore scroll position when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadSavedHighlights();
            
            // Restore scroll position
            const savedScroll = {{ saved_scroll }};
            if (savedScroll > 0) {
                // Try multiple times to ensure content is loaded
                const mainElement = document.getElementById('main');
                let attempts = 0;
                const restoreScroll = () => {
                    mainElement.scrollTop = savedScroll;
                    currentScrollPosition = savedScroll;
                    
                    // Verify it worked, retry if needed
                    if (mainElement.scrollTop < savedScroll - 10 && attempts < 5) {
                        attempts++;
                        setTimeout(restoreScroll, 200);
                    }
                };
                setTimeout(restoreScroll, 100);
            }
            
            // Scroll TOC to show active item
            const activeLink = document.querySelector('.toc-link.active');
            if (activeLink) {
                const sidebar = document.getElementById('sidebar');
                const linkTop = activeLink.offsetTop;
                const linkHeight = activeLink.offsetHeight;
                const sidebarHeight = sidebar.clientHeight;
                
                // Scroll so active item is roughly in the middle of the sidebar
                sidebar.scrollTop = linkTop - (sidebarHeight / 2) + (linkHeight / 2);
            }
            
            // Setup progress saving on navigation
            setupProgressSaving();
        });
        
        // Track current scroll position
        let currentScrollPosition = 0;
        
        // Update scroll position on scroll
        document.getElementById('main').addEventListener('scroll', function() {
            currentScrollPosition = Math.round(this.scrollTop);
        });
        
        // Save reading progress with scroll position
        function saveProgress() {
            return fetch(`/api/progress?book_id=${encodeURIComponent(BOOK_ID)}&chapter_index=${CHAPTER_INDEX}&scroll_position=${currentScrollPosition}`, {
                method: 'POST',
                keepalive: true  // Ensure request completes even if page unloads
            }).catch(error => {
                console.error('Failed to save progress:', error);
            });
        }
        
        // Setup progress saving listeners
        function setupProgressSaving() {
            // Save progress when navigating away or closing (use both events for better compatibility)
            window.addEventListener('beforeunload', function(e) {
                saveProgress();
            });
            
            window.addEventListener('pagehide', function(e) {
                saveProgress();
            });
            
            // Save progress when clicking navigation links
            document.querySelectorAll('.nav-btn:not(.disabled)').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveProgress().then(() => {
                        window.location.href = this.href;
                    });
                });
            });
            
            // Save progress when clicking back to library
            const homeLink = document.querySelector('.nav-home');
            if (homeLink) {
                homeLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveProgress().then(() => {
                        window.location.href = this.href;
                    });
                });
            }
        }

        // Prevent default context menu on book content
        document.getElementById('book-content').addEventListener('contextmenu', function(e) {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            
            if (text.length > 0) {
                e.preventDefault();
                selectedText = text;
                
                // Get context
                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer.parentElement;
                selectedContext = container.textContent || "";
                
                showContextMenu(e.pageX, e.pageY);
            }
        });

        // Hide context menu when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#context-menu')) {
                hideContextMenu();
            }
        });

        function showContextMenu(x, y) {
            const menu = document.getElementById('context-menu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
        }

        function hideContextMenu() {
            document.getElementById('context-menu').style.display = 'none';
        }

        async function handleContextAction(actionType) {
            hideContextMenu();
            
            if (!selectedText) return;

            currentAnalysisType = actionType;
            
            // Show panel
            openPanel();
            
            // Reset IDs
            currentHighlightId = null;
            currentAnalysisId = null;
            
            // Hide saved indicator
            document.getElementById('saved-indicator').classList.remove('show');
            
            // Handle comment action differently
            if (actionType === 'comment') {
                // Show comment input UI
                document.getElementById('panel-title').textContent = 'üí¨ Ê∑ªÂä†Á¨îËÆ∞';
                document.getElementById('panel-selected-text').textContent = selectedText;
                
                // Hide analysis box, show comment input
                document.getElementById('analysis-box').style.display = 'none';
                document.getElementById('comment-input-area').style.display = 'block';
                document.getElementById('comment-textarea').value = '';
                document.getElementById('comment-textarea').focus();
                
                // Show comment actions, hide AI actions
                document.getElementById('panel-actions').style.display = 'none';
                document.getElementById('comment-actions').style.display = 'flex';
                document.getElementById('save-comment-btn').style.display = 'inline-block';
                document.getElementById('update-comment-btn').style.display = 'none';
                document.getElementById('delete-comment-btn').style.display = 'none';
                
                return;
            }
            
            // Handle AI actions (fact_check, discussion)
            // Show analysis box, hide comment input
            document.getElementById('analysis-box').style.display = 'block';
            document.getElementById('comment-input-area').style.display = 'none';
            document.getElementById('panel-actions').style.display = 'flex';
            document.getElementById('comment-actions').style.display = 'none';
            
            // Update panel content
            document.getElementById('panel-title').textContent = 
                actionType === 'fact_check' ? 'üìã Ëß£ÈáäËØ¥Êòé' : 'üí° Ê∑±ÂÖ•ËÆ®ËÆ∫';
            document.getElementById('panel-selected-text').textContent = selectedText;
            document.getElementById('panel-analysis-type').textContent = 
                actionType === 'fact_check' ? 'Ëß£ÈáäËØ¥Êòé' : 'Ê∑±ÂÖ•ËÆ®ËÆ∫';
            document.getElementById('panel-analysis-content').innerHTML = 
                '<div class="loading">Ê≠£Âú®ÂàÜÊûê‰∏≠...</div>';
            
            // Disable save button
            document.getElementById('save-btn').disabled = true;

            try {
                // Call AI analysis (without saving)
                const aiRes = await fetch('/api/ai/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        highlight_id: 0,  // Temporary, not saved yet
                        analysis_type: actionType,
                        selected_text: selectedText,
                        context: selectedContext
                    })
                });

                const aiData = await aiRes.json();
                
                if (aiData.status === 'success') {
                    // Render markdown
                    document.getElementById('panel-analysis-content').innerHTML = marked.parse(aiData.response);
                    // Enable save button
                    document.getElementById('save-btn').disabled = false;
                } else {
                    document.getElementById('panel-analysis-content').textContent = 'ÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ';
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('panel-analysis-content').textContent = 'ÂèëÁîüÈîôËØØ: ' + error.message;
            }
        }

        async function saveAnalysis() {
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';
            
            try {
                // Step 1: Save highlight
                const highlightRes = await fetch('/api/highlight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        book_id: BOOK_ID,
                        chapter_index: CHAPTER_INDEX,
                        selected_text: selectedText,
                        context_before: selectedContext.substring(0, 200),
                        context_after: selectedContext.substring(selectedContext.length - 200)
                    })
                });

                const highlightData = await highlightRes.json();
                currentHighlightId = highlightData.highlight_id;

                // Step 2: Save analysis
                const analysisContent = document.getElementById('panel-analysis-content').textContent;
                
                const saveRes = await fetch('/api/ai/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        highlight_id: currentHighlightId,
                        analysis_type: currentAnalysisType,
                        prompt: selectedText,
                        response: analysisContent
                    })
                });

                const saveData = await saveRes.json();
                
                if (saveData.status === 'success') {
                    currentAnalysisId = saveData.analysis_id;
                    document.getElementById('saved-indicator').classList.add('show');
                    saveBtn.textContent = 'Â∑≤‰øùÂ≠ò';
                    
                    // Reload highlights to show the new one
                    await loadSavedHighlights();
                } else {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '‰øùÂ≠òÂ§±Ë¥•';
                    setTimeout(() => {
                        saveBtn.textContent = '‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì';
                    }, 2000);
                }

            } catch (error) {
                console.error('Error:', error);
                saveBtn.disabled = false;
                saveBtn.textContent = '‰øùÂ≠òÂ§±Ë¥•';
                setTimeout(() => {
                    saveBtn.textContent = '‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì';
                }, 2000);
            }
        }

        function openPanel() {
            document.getElementById('ai-panel').classList.remove('hidden');
            document.getElementById('toggle-panel-btn').classList.add('hidden');
        }

        function closePanel() {
            document.getElementById('ai-panel').classList.add('hidden');
            document.getElementById('toggle-panel-btn').classList.remove('hidden');
            window.getSelection().removeAllRanges();
            
            // Reset panel state
            document.getElementById('save-btn').style.display = 'inline-block';
            document.getElementById('saved-indicator').classList.remove('show');
            document.getElementById('analysis-box').style.display = 'block';
            document.getElementById('comment-input-area').style.display = 'none';
            document.getElementById('panel-actions').style.display = 'flex';
            document.getElementById('comment-actions').style.display = 'none';
        }
        
        // Comment functions
        async function saveComment() {
            const commentText = document.getElementById('comment-textarea').value.trim();
            
            if (!commentText) {
                alert('ËØ∑ËæìÂÖ•Á¨îËÆ∞ÂÜÖÂÆπ');
                return;
            }
            
            const saveBtn = document.getElementById('save-comment-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';
            
            try {
                // Step 1: Save highlight
                const highlightRes = await fetch('/api/highlight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        book_id: BOOK_ID,
                        chapter_index: CHAPTER_INDEX,
                        selected_text: selectedText,
                        context_before: selectedContext.substring(0, 200),
                        context_after: selectedContext.substring(selectedContext.length - 200)
                    })
                });

                const highlightData = await highlightRes.json();
                currentHighlightId = highlightData.highlight_id;

                // Step 2: Save comment as analysis
                const saveRes = await fetch('/api/ai/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        highlight_id: currentHighlightId,
                        analysis_type: 'comment',
                        prompt: selectedText,
                        response: commentText
                    })
                });

                const saveData = await saveRes.json();
                
                if (saveData.status === 'success') {
                    currentAnalysisId = saveData.analysis_id;
                    document.getElementById('saved-indicator').classList.add('show');
                    saveBtn.textContent = 'Â∑≤‰øùÂ≠ò';
                    
                    // Reload highlights to show the new comment
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '‰øùÂ≠òÂ§±Ë¥•';
                    setTimeout(() => {
                        saveBtn.textContent = '‰øùÂ≠òÁ¨îËÆ∞';
                    }, 2000);
                }

            } catch (error) {
                console.error('Error:', error);
                saveBtn.disabled = false;
                saveBtn.textContent = '‰øùÂ≠òÂ§±Ë¥•';
                setTimeout(() => {
                    saveBtn.textContent = '‰øùÂ≠òÁ¨îËÆ∞';
                }, 2000);
            }
        }
        
        async function updateComment() {
            const commentText = document.getElementById('comment-textarea').value.trim();
            
            if (!commentText) {
                alert('ËØ∑ËæìÂÖ•Á¨îËÆ∞ÂÜÖÂÆπ');
                return;
            }
            
            const updateBtn = document.getElementById('update-comment-btn');
            updateBtn.disabled = true;
            updateBtn.textContent = 'Êõ¥Êñ∞‰∏≠...';
            
            try {
                const response = await fetch(`/api/ai/update/${currentAnalysisId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        response: commentText
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    updateBtn.textContent = 'Â∑≤Êõ¥Êñ∞';
                    document.getElementById('saved-indicator').classList.add('show');
                    
                    // Reload to show updated comment
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    updateBtn.disabled = false;
                    updateBtn.textContent = 'Êõ¥Êñ∞Â§±Ë¥•';
                    setTimeout(() => {
                        updateBtn.textContent = 'Êõ¥Êñ∞Á¨îËÆ∞';
                    }, 2000);
                }

            } catch (error) {
                console.error('Error:', error);
                updateBtn.disabled = false;
                updateBtn.textContent = 'Êõ¥Êñ∞Â§±Ë¥•';
                setTimeout(() => {
                    updateBtn.textContent = 'Êõ¥Êñ∞Á¨îËÆ∞';
                }, 2000);
            }
        }
        
        async function deleteComment() {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Á¨îËÆ∞ÂêóÔºü')) {
                return;
            }
            
            const deleteBtn = document.getElementById('delete-comment-btn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Âà†Èô§‰∏≠...';
            
            try {
                const response = await fetch(`/api/ai/delete/${currentAnalysisId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    deleteBtn.textContent = 'Â∑≤Âà†Èô§';
                    
                    // Reload to remove the highlight
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Âà†Èô§Â§±Ë¥•';
                    setTimeout(() => {
                        deleteBtn.textContent = 'Âà†Èô§';
                    }, 2000);
                }

            } catch (error) {
                console.error('Error:', error);
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Âà†Èô§Â§±Ë¥•';
                setTimeout(() => {
                    deleteBtn.textContent = 'Âà†Èô§';
                }, 2000);
            }
        }

        function togglePanel() {
            const panel = document.getElementById('ai-panel');
            if (panel.classList.contains('hidden')) {
                openPanel();
            } else {
                closePanel();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Don't trigger if user is typing in a text field
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
                return;
            }
            
            if (e.key === 'Escape') {
                closePanel();
                hideContextMenu();
                closeModal();
            } else if (e.key === 'ArrowLeft') {
                // Previous chapter - find the first prev button that's not disabled
                const prevBtn = document.querySelector('.chapter-nav a.nav-btn:first-child:not(.disabled)');
                if (prevBtn) {
                    e.preventDefault();
                    window.location.href = prevBtn.href;
                }
            } else if (e.key === 'ArrowRight') {
                // Next chapter - find the last next button that's not disabled
                const nextBtn = document.querySelector('.chapter-nav a.nav-btn:last-child:not(.disabled)');
                if (nextBtn) {
                    e.preventDefault();
                    window.location.href = nextBtn.href;
                }
            }
        });
        
        // Intercept internal links and show in modal
        document.getElementById('book-content').addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && link.href) {
                const url = new URL(link.href);
                // Check if it's an internal link to this book
                if (url.pathname.includes('/read/')) {
                    e.preventDefault();
                    showLinkModal(url.pathname);
                }
            }
        });
        
        async function showLinkModal(path) {
            const modal = document.getElementById('link-modal');
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');
            
            modal.classList.add('show');
            modalBody.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Loading...</div>';
            modalTitle.textContent = 'Reference';
            
            try {
                const response = await fetch(path);
                const html = await response.text();
                
                // Parse the HTML to extract just the content
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.querySelector('.book-content');
                
                if (content) {
                    modalBody.innerHTML = content.innerHTML;
                } else {
                    modalBody.innerHTML = '<p>Content not found</p>';
                }
            } catch (error) {
                modalBody.innerHTML = '<p>Error loading content</p>';
                console.error('Error loading modal content:', error);
            }
        }
        
        function closeModal(event) {
            // Only close if clicking overlay or close button, not the content
            if (!event || event.target.id === 'link-modal' || event.target.classList.contains('modal-close')) {
                document.getElementById('link-modal').classList.remove('show');
            }
        }
        
        // Reading settings
        function toggleSettings(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('settings-dropdown');
            dropdown.classList.toggle('show');
        }
        
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('reader-theme', theme);
            
            // Update active button
            document.querySelectorAll('.settings-option[data-theme]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Close settings when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.settings-container')) {
                document.getElementById('settings-dropdown').classList.remove('show');
            }
        });
        
        function setFont(fontFamily) {
            document.getElementById('book-content').style.fontFamily = fontFamily;
            localStorage.setItem('reader-font', fontFamily);
            
            // Update active button
            document.querySelectorAll('.settings-option[data-font]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function setFontSize(size) {
            document.getElementById('book-content').style.fontSize = size + 'px';
            document.getElementById('font-size-value').textContent = size + 'px';
            localStorage.setItem('reader-font-size', size);
        }
        
        function setLineHeight(height) {
            document.getElementById('book-content').style.lineHeight = height;
            document.getElementById('line-height-value').textContent = height;
            localStorage.setItem('reader-line-height', height);
        }
        
        // Load saved settings on page load
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('reader-theme');
            const savedFont = localStorage.getItem('reader-font');
            const savedSize = localStorage.getItem('reader-font-size');
            const savedHeight = localStorage.getItem('reader-line-height');
            
            // Apply saved theme
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelectorAll('.settings-option[data-theme]').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-theme') === 'dark') {
                        btn.classList.add('active');
                    }
                });
            }
            
            if (savedFont) {
                document.getElementById('book-content').style.fontFamily = savedFont;
                // Update active button
                const fontMap = {
                    'Georgia, serif': 'georgia',
                    'Times New Roman, serif': 'times',
                    '-apple-system, sans-serif': 'sans',
                    'Arial, sans-serif': 'arial',
                    'Verdana, sans-serif': 'verdana',
                    'Microsoft YaHei, sans-serif': 'yahei',
                    'SimSun, serif': 'simsun',
                    'Consolas, monospace': 'mono'
                };
                const fontType = fontMap[savedFont];
                if (fontType) {
                    document.querySelectorAll('.settings-option[data-font]').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.getAttribute('data-font') === fontType) {
                            btn.classList.add('active');
                        }
                    });
                }
            }
            
            if (savedSize) {
                document.getElementById('book-content').style.fontSize = savedSize + 'px';
                document.querySelector('.settings-slider[min="14"]').value = savedSize;
                document.getElementById('font-size-value').textContent = savedSize + 'px';
            }
            
            if (savedHeight) {
                document.getElementById('book-content').style.lineHeight = savedHeight;
                document.querySelector('.settings-slider[min="1.4"]').value = savedHeight;
                document.getElementById('line-height-value').textContent = savedHeight;
            }
        });
    </script>
</body>
</html>
