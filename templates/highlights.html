<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highlights - {{ book_title }} - My Reader with AI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìö</text></svg>">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 40px; line-height: 1.6; transition: background-color 0.3s, color 0.3s; }
        
        /* Dark mode */
        body.dark-mode { background: #1a1a1a; color: #e0e0e0; }
        body.dark-mode .header { border-bottom-color: #404040; }
        body.dark-mode h1 { color: #e0e0e0; }
        body.dark-mode .back-link { color: #64b5f6; }
        body.dark-mode .stats-bar { background: #2d2d2d; border-color: #404040; }
        body.dark-mode .stat-item { color: #e0e0e0; }
        body.dark-mode .filter-bar { background: #2d2d2d; border-color: #404040; }
        body.dark-mode .filter-btn { background: #252525; border-color: #404040; color: #e0e0e0; }
        body.dark-mode .filter-btn:hover { background: #3d3d3d; }
        body.dark-mode .filter-btn.active { background: #64b5f6; color: #1a1a1a; }
        body.dark-mode .highlight-item { background: #2d2d2d; border-left-color: #ffc107; }
        body.dark-mode .highlight-item:hover { box-shadow: 0 2px 8px rgba(255,255,255,0.1); }
        body.dark-mode .highlight-item.fact_check { background: #3d3520; }
        body.dark-mode .highlight-item.discussion { background: #1d2d3d; }
        body.dark-mode .highlight-item.comment { background: #1d3d2d; }
        body.dark-mode .highlight-type { color: #ffd54f; }
        body.dark-mode .highlight-chapter { color: #999; }
        body.dark-mode .highlight-text { color: #d0d0d0; background: #252525; border-color: #404040; }
        body.dark-mode .analysis-content { color: #d0d0d0; }
        body.dark-mode .analysis-content code { background: #3d3d3d; }
        body.dark-mode .analysis-content pre { background: #3d3d3d; }
        body.dark-mode .analysis-content blockquote { border-left-color: #555; color: #999; }
        body.dark-mode .analysis-content a { color: #64b5f6; }
        body.dark-mode .highlight-actions { border-top-color: #404040; }
        body.dark-mode .action-btn { background: #404040; color: #e0e0e0; }
        body.dark-mode .action-btn:hover { background: #505050; }
        body.dark-mode .action-btn.delete:hover { background: #5d2020; }
        body.dark-mode .export-section { background: #2d2d2d; border-color: #404040; }
        body.dark-mode .export-btn { background: #64b5f6; color: #1a1a1a; }
        body.dark-mode .export-btn:hover { background: #42a5f5; }
        body.dark-mode .warning-box { background: #3d2d1d; border-color: #ffc107; color: #ffd54f; }
        body.dark-mode .empty-state { color: #666; }
        
        /* Theme toggle button */
        .theme-toggle { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: white; 
            border: 1px solid #ddd; 
            font-size: 1.2em; 
            cursor: pointer; 
            padding: 8px 12px; 
            border-radius: 6px; 
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .theme-toggle:hover { 
            background: #f8f9fa; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        body.dark-mode .theme-toggle { 
            background: #2d2d2d; 
            border-color: #404040; 
        }
        body.dark-mode .theme-toggle:hover { 
            background: #3d3d3d; 
        }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #e9ecef; padding-bottom: 20px; margin-bottom: 30px; }
        .back-link { display: inline-block; color: #3498db; text-decoration: none; margin-bottom: 15px; font-size: 0.9em; }
        .back-link:hover { text-decoration: underline; }
        h1 { color: #2c3e50; margin: 0 0 10px 0; font-size: 2em; }
        .book-meta { color: #666; font-size: 0.95em; }
        .stats { display: flex; gap: 30px; margin-top: 15px; }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: #666; }
        .stat-icon { font-size: 1.2em; }
        
        .filter-bar { display: flex; gap: 10px; margin-bottom: 30px; padding: 15px; background: #f8f9fa; border-radius: 6px; }
        .filter-btn { padding: 8px 16px; border: 1px solid #dee2e6; background: white; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .filter-btn:hover { background: #e9ecef; }
        .filter-btn.active { background: #3498db; color: white; border-color: #3498db; }
        
        .highlight-item { margin-bottom: 30px; padding: 20px; border-left: 4px solid #ffc107; background: #fffbf0; border-radius: 4px; transition: all 0.2s; }
        .highlight-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .highlight-item.fact_check { border-left-color: #ffc107; background: #fffbf0; }
        .highlight-item.discussion { border-left-color: #2196f3; background: #f0f7ff; }
        .highlight-item.comment { border-left-color: #4caf50; background: #f1f8f4; }
        
        .highlight-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .highlight-type { display: inline-flex; align-items: center; gap: 6px; font-size: 0.85em; color: #666; font-weight: 500; }
        .highlight-date { font-size: 0.8em; color: #999; }
        .highlight-chapter { font-size: 0.85em; color: #666; margin-bottom: 10px; }
        
        .highlight-text { font-size: 1.05em; color: #2c3e50; margin-bottom: 15px; font-style: italic; line-height: 1.7; }
        
        .analysis-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1); }
        .analysis-label { font-size: 0.85em; color: #666; font-weight: 500; margin-bottom: 8px; }
        .analysis-content { color: #495057; line-height: 1.7; }
        
        /* Markdown styling */
        .analysis-content h1, .analysis-content h2, .analysis-content h3 { margin-top: 1em; margin-bottom: 0.5em; color: #2c3e50; }
        .analysis-content h1 { font-size: 1.3em; border-bottom: 2px solid #e9ecef; padding-bottom: 0.3em; }
        .analysis-content h2 { font-size: 1.15em; }
        .analysis-content h3 { font-size: 1.05em; }
        .analysis-content p { margin-bottom: 0.8em; }
        .analysis-content ul, .analysis-content ol { margin-left: 1.5em; margin-bottom: 0.8em; }
        .analysis-content li { margin-bottom: 0.3em; }
        .analysis-content code { background: #f5f5f5; padding: 2px 5px; border-radius: 3px; font-family: 'Consolas', monospace; font-size: 0.9em; }
        .analysis-content pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; margin-bottom: 0.8em; }
        .analysis-content pre code { background: none; padding: 0; }
        .analysis-content blockquote { border-left: 3px solid #ddd; padding-left: 1em; margin-left: 0; color: #666; font-style: italic; }
        .analysis-content strong { font-weight: 600; color: #2c3e50; }
        .analysis-content em { font-style: italic; }
        .analysis-content a { color: #3498db; text-decoration: none; }
        .analysis-content a:hover { text-decoration: underline; }
        .analysis-content hr { border: none; border-top: 1px solid #e9ecef; margin: 1em 0; }
        
        .action-links { margin-top: 12px; display: flex; gap: 15px; }
        .action-link { color: #3498db; text-decoration: none; font-size: 0.85em; }
        .action-link:hover { text-decoration: underline; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-icon { font-size: 4em; margin-bottom: 20px; }
        .empty-text { font-size: 1.1em; margin-bottom: 10px; }
        .empty-subtext { font-size: 0.9em; }
        
        .export-btn { float: right; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .export-btn:hover { background: #218838; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <span id="theme-icon">üåô</span>
    </button>
    
    <div class="container">
        <div class="header">
            <a href="/" class="back-link">‚Üê Back to Library</a>
            <button class="export-btn" onclick="exportHighlights()">üì• Export</button>
            <h1>{{ book_title }}</h1>
            <div class="book-meta">All your highlights and notes</div>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-icon">üìã</span>
                    <span>{{ stats.fact_check }} Ëß£ÈáäËØ¥Êòé</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">üí°</span>
                    <span>{{ stats.discussion }} Discussions</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">üí¨</span>
                    <span>{{ stats.comment }} Comments</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">üìù</span>
                    <span>{{ stats.total }} Total</span>
                </div>
            </div>
        </div>
        
        {% if highlights %}
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterHighlights('all')">ÂÖ®ÈÉ®</button>
            <button class="filter-btn" onclick="filterHighlights('fact_check')">üìã Ëß£ÈáäËØ¥Êòé</button>
            <button class="filter-btn" onclick="filterHighlights('discussion')">üí° Ê∑±ÂÖ•ËÆ®ËÆ∫</button>
            <button class="filter-btn" onclick="filterHighlights('comment')">üí¨ ‰∏™‰∫∫Á¨îËÆ∞</button>
        </div>
        
        <div id="highlights-container">
            {% for item in highlights %}
            <div class="highlight-item {{ item.analysis_type }}" data-type="{{ item.analysis_type }}">
                <div class="highlight-header">
                    <div class="highlight-type">
                        {% if item.analysis_type == 'fact_check' %}
                        üìã Ëß£ÈáäËØ¥Êòé
                        {% elif item.analysis_type == 'discussion' %}
                        üí° Ê∑±ÂÖ•ËÆ®ËÆ∫
                        {% elif item.analysis_type == 'comment' %}
                        üí¨ Comment
                        {% endif %}
                    </div>
                    <div class="highlight-date">{{ item.created_at }}</div>
                </div>
                
                <div class="highlight-chapter">Chapter {{ item.chapter_index + 1 }}</div>
                
                <div class="highlight-text">"{{ item.selected_text }}"</div>
                
                {% if item.response %}
                <div class="analysis-section">
                    <div class="analysis-label">
                        {% if item.analysis_type == 'comment' %}
                        Your Note:
                        {% else %}
                        AI Analysis:
                        {% endif %}
                    </div>
                    <div class="analysis-content" data-type="{{ item.analysis_type }}">{{ item.response }}</div>
                </div>
                {% endif %}
                
                <div class="action-links">
                    <a href="/read/{{ book_id }}/{{ item.chapter_index }}" class="action-link">‚Üí Go to chapter</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìö</div>
            <div class="empty-text">No highlights yet</div>
            <div class="empty-subtext">Start reading and highlight interesting passages!</div>
            <div style="margin-top: 20px;">
                <a href="/read/{{ book_id }}/0" class="action-link" style="font-size: 1em;">Start Reading ‚Üí</a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    
    <script>
        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                icon.textContent = 'üåô';
                localStorage.setItem('reader-theme', 'light');
            } else {
                body.classList.add('dark-mode');
                icon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('reader-theme', 'dark');
            }
        }
        
        // Load saved theme
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('reader-theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            }
        });
        
        // Configure marked for safe rendering
        marked.setOptions({
            breaks: true,
            gfm: true
        });
        
        // Render markdown for AI responses (not comments)
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.analysis-content').forEach(element => {
                const type = element.getAttribute('data-type');
                // Only render markdown for AI responses (fact_check, discussion)
                if (type === 'fact_check' || type === 'discussion') {
                    const text = element.textContent;
                    element.innerHTML = marked.parse(text);
                }
            });
        });
        
        let currentFilter = 'all';
        
        function filterHighlights(type) {
            currentFilter = type;
            const items = document.querySelectorAll('.highlight-item');
            const buttons = document.querySelectorAll('.filter-btn');
            
            // Update button states
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter items
            items.forEach(item => {
                if (type === 'all' || item.dataset.type === type) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function exportHighlights() {
            const items = document.querySelectorAll('.highlight-item');
            const bookTitle = "{{ book_title }}";
            const exportData = [];
            
            // Collect visible highlights
            items.forEach(item => {
                if (item.style.display !== 'none') {
                    const type = item.dataset.type;
                    const typeLabel = type === 'fact_check' ? 'Ëß£ÈáäËØ¥Êòé' : 
                                     type === 'discussion' ? 'Ê∑±ÂÖ•ËÆ®ËÆ∫' : '‰∏™‰∫∫Á¨îËÆ∞';
                    const chapter = item.querySelector('.highlight-chapter').textContent;
                    const text = item.querySelector('.highlight-text').textContent.replace(/^"|"$/g, '');
                    const analysisContent = item.querySelector('.analysis-content');
                    const analysis = analysisContent ? analysisContent.textContent.trim() : '';
                    
                    exportData.push({
                        type: typeLabel,
                        chapter: chapter,
                        text: text,
                        analysis: analysis
                    });
                }
            });
            
            // Create markdown format
            let markdown = `# ${bookTitle} - Highlights\n\n`;
            markdown += `Exported: ${new Date().toLocaleString()}\n`;
            markdown += `Filter: ${currentFilter === 'all' ? 'All' : currentFilter.replace('_', ' ')}\n`;
            markdown += `Total: ${exportData.length} highlights\n\n`;
            markdown += `---\n\n`;
            
            exportData.forEach((item, index) => {
                markdown += `## ${index + 1}. ${item.type}\n\n`;
                markdown += `**${item.chapter}**\n\n`;
                markdown += `> ${item.text}\n\n`;
                if (item.analysis) {
                    markdown += `### Analysis:\n\n${item.analysis}\n\n`;
                }
                markdown += `---\n\n`;
            });
            
            // Check length and warn if too large
            const charCount = markdown.length;
            const tokenEstimate = Math.ceil(charCount / 4); // Rough estimate: 1 token ‚âà 4 chars
            
            if (tokenEstimate > 100000) {
                if (!confirm(`‚ö†Ô∏è Warning: Export is very large (~${tokenEstimate.toLocaleString()} tokens, ${(charCount/1000).toFixed(1)}K chars).\n\nThis exceeds most AI context limits (e.g., GPT-4: 128K, Claude: 200K).\n\nConsider filtering to reduce size.\n\nContinue export anyway?`)) {
                    return;
                }
            } else if (tokenEstimate > 50000) {
                if (!confirm(`‚ö†Ô∏è Notice: Export is large (~${tokenEstimate.toLocaleString()} tokens, ${(charCount/1000).toFixed(1)}K chars).\n\nThis may exceed some AI context limits.\n\nContinue export?`)) {
                    return;
                }
            }
            
            // Download file
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = `${bookTitle.replace(/[^a-z0-9]/gi, '_')}_highlights_${Date.now()}.md`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
